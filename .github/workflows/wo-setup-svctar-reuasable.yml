# Resusable workflow to wo-ready a given cluster
# if woready, it will also configure service groups and targets

name: wo-setup-svctar (Reusable)

on:
  workflow_call:
    inputs:
      site:
        required: true
        type: string
      rg:
        required: true
        type: string
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
      AZURE_SUBSCRIPTION_ID:
        required: true

jobs:

  wo-setup-svctar-cls:
    env:
      site: ${{ inputs.site }}
      rg: ${{ inputs.rg }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Azure setup
      id: azsetup
      uses: ./.github/actions/wo-azure-setup
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        azcliversion: "2.73.0"

    - name: Source site info
      id: siteinfo
      uses: ./.github/actions/wo-get-site-info
      with:
        site: ${{ inputs.site }}
        rg: ${{ inputs.rg }}

    - name: Setup resource group
      id: rgsetup
      run: |
        az group create --location ${{ steps.siteinfo.outputs.siteLoc }}  --name ${{ steps.siteinfo.outputs.rg }}

    - name: Check for WO readiness
      id: check-wo-ready
      uses: ./.github/actions/wo-check-woready-cluster
      with:
        site: ${{ inputs.site }}
        rg: ${{ inputs.rg }}
        siteClsName: ${{ steps.siteinfo.outputs.siteClsName }}

    - name: Create service groups
      if: ${{ steps.check-wo-ready.outputs.woready == 'true' }}
      uses: ./.github/actions/wo-setup-svgrps
      with:
        site: ${{ inputs.site }}

    - name: Create targets
      if: ${{ steps.check-wo-ready.outputs.woready == 'true' }}
      uses: ./.github/actions/wo-setup-targets
      with:
        site: ${{ inputs.sites }}
        rg: ${{ inputs.rg }}
